{% extends "base.html" %}

{% block title %}Proxy - {{ node['node_id'] }} - Crebain Portal{% endblock %}

{% block content %}
<nav class="navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <img src="/static/images/crebain_logo.png" alt="Crebain" height="30" class="me-2">Crebain
        </a>
        <span class="navbar-text">
            HTTP Proxy Management
        </span>
    </div>
</nav>

<div class="container-fluid mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/" style="color: #6c757d;">Home</a></li>
            <li class="breadcrumb-item"><a href="/node/{{ node['node_id'] }}" style="color: #6c757d;">{{ node['node_id'] }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Proxy</li>
        </ol>
    </nav>

    <!-- Navigation Tabs -->
    <div class="mb-4">
        <a href="/node/{{ node['node_id'] }}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-info-circle"></i> Details
        </a>
        <a href="/node/{{ node['node_id'] }}/commands" class="btn btn-outline-secondary me-2">
            <i class="fas fa-terminal"></i> Commands
        </a>
        <a href="/node/{{ node['node_id'] }}/files" class="btn btn-outline-secondary me-2">
            <i class="fas fa-folder"></i> Files
        </a>
        <a href="/node/{{ node['node_id'] }}/logs" class="btn btn-outline-secondary me-2">
            <i class="fas fa-list"></i> Logs
        </a>
        <a href="/node/{{ node['node_id'] }}/proxy" class="btn btn-primary">
            <i class="fas fa-network-wired"></i> Proxy
        </a>
    </div>

    <!-- Proxy Status Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-network-wired"></i> HTTP Proxy Status</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label"><strong>Status:</strong></label>
                        <div>
                            {% if proxy_enabled is none %}
                                <span class="badge bg-secondary">Unknown</span>
                                <p class="text-muted-custom mt-2">Click "Refresh Status" to get current proxy state</p>
                            {% elif proxy_enabled %}
                                <span class="badge bg-success"><i class="fas fa-check-circle"></i> Enabled</span>
                            {% else %}
                                <span class="badge bg-danger"><i class="fas fa-times-circle"></i> Disabled</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if proxy_port %}
                    <div class="mb-3">
                        <label class="form-label"><strong>Proxy Port:</strong></label>
                        <div>
                            <code class="bg-darker p-2 rounded">127.0.0.1:{{ proxy_port }}</code>
                        </div>
                    </div>
                    {% endif %}

                    <button class="btn btn-info" onclick="refreshStatus()">
                        <i class="fas fa-sync-alt"></i> Refresh Status
                    </button>
                </div>

                <div class="col-md-6">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> About HTTP Proxy</h6>
                        <p class="mb-0">The HTTP proxy allows you to tunnel web requests through the RNS network. When enabled, you can use:</p>
                        <code class="mt-2 d-block">curl -x http://127.0.0.1:{{ proxy_port or '8080' }} http://example.com</code>
                    </div>
                </div>
            </div>
            <div id="statusMessage" class="mt-3" style="display: none;"></div>
        </div>
    </div>

    <!-- Proxy Control Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-cogs"></i> Proxy Control</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Enable Proxy</h6>
                    <form id="enableForm">
                        <div class="mb-3">
                            <label for="portInput" class="form-label">Port</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                   id="portInput" value="{{ proxy_port or '8080' }}" min="1024" max="65535">
                            <div class="form-text text-muted-custom">
                                Port for the proxy server (1024-65535)
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-play"></i> Enable Proxy
                        </button>
                    </form>
                </div>
                <div class="col-md-6">
                    <h6>Disable Proxy</h6>
                    <p class="text-muted-custom">Stop the HTTP proxy server on the client</p>
                    <button class="btn btn-danger" onclick="disableProxy()">
                        <i class="fas fa-stop"></i> Disable Proxy
                    </button>
                </div>
            </div>
            <div id="controlMessage" class="mt-3" style="display: none;"></div>
        </div>
    </div>

    <!-- Usage Instructions -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-book"></i> Usage Instructions</h5>
        </div>
        <div class="card-body">
            <h6>Using the Proxy</h6>
            <p>Once the proxy is enabled, you can use it with any HTTP client that supports HTTP proxies:</p>

            <div class="mb-3">
                <strong>With curl:</strong>
                <pre class="json-preview">curl -x http://127.0.0.1:{{ proxy_port or '8080' }} http://example.com</pre>
            </div>

            <div class="mb-3">
                <strong>With wget:</strong>
                <pre class="json-preview">wget -e use_proxy=yes -e http_proxy=127.0.0.1:{{ proxy_port or '8080' }} http://example.com</pre>
            </div>

            <div class="mb-3">
                <strong>With Python requests:</strong>
                <pre class="json-preview">import requests
proxies = {'http': 'http://127.0.0.1:{{ proxy_port or '8080' }}'}
r = requests.get('http://example.com', proxies=proxies)</pre>
            </div>

            <div class="alert alert-warning mt-3">
                <strong><i class="fas fa-exclamation-triangle"></i> Note:</strong> The proxy only supports HTTP requests, not HTTPS CONNECT tunneling. Use for HTTP-only resources.
            </div>
        </div>
    </div>
</div>

<script>
function showMessage(elementId, className, text) {
    const messageDiv = document.getElementById(elementId);
    messageDiv.className = `alert ${className}`;
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';

    // Hide after 5 seconds
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

async function refreshStatus() {
    try {
        const response = await fetch('/node/{{ node["node_id"] }}/proxy/status', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showMessage('statusMessage', 'alert-success', result.message + ' - Reload page in a few seconds to see status.');
            setTimeout(() => location.reload(), 3000);
        } else {
            showMessage('statusMessage', 'alert-danger', 'Error: ' + result.error);
        }
    } catch (error) {
        showMessage('statusMessage', 'alert-danger', 'Error: ' + error.message);
    }
}

document.getElementById('enableForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const port = document.getElementById('portInput').value;

    try {
        const response = await fetch('/node/{{ node["node_id"] }}/proxy/enable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'port=' + encodeURIComponent(port)
        });

        const result = await response.json();

        if (result.success) {
            showMessage('controlMessage', 'alert-success', result.message + ' - Reload page in a few seconds to see status.');
            setTimeout(() => location.reload(), 3000);
        } else {
            showMessage('controlMessage', 'alert-danger', 'Error: ' + result.error);
        }
    } catch (error) {
        showMessage('controlMessage', 'alert-danger', 'Error: ' + error.message);
    }
});

async function disableProxy() {
    try {
        const response = await fetch('/node/{{ node["node_id"] }}/proxy/disable', {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showMessage('controlMessage', 'alert-success', result.message + ' - Reload page in a few seconds to see status.');
            setTimeout(() => location.reload(), 3000);
        } else {
            showMessage('controlMessage', 'alert-danger', 'Error: ' + result.error);
        }
    } catch (error) {
        showMessage('controlMessage', 'alert-danger', 'Error: ' + error.message);
    }
}
</script>

{% endblock %}
